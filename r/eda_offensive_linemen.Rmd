---
title: "EDA - Offensive Line"
output: html_notebook
---

# Purpose

Use tracking data, specifically with offensive linemen, to detect patterns
in offensive play-calling i.e. run/pass splits.

# Setup

## Libraries

```{r}
library(tidyverse)
```

## Data

```{r}
# non-tracking data
games <- readr::read_csv('./input/games.csv')
players <- readr::read_csv('./input/players.csv')
plays <- readr::read_csv('./input/plays.csv')
player_play <- readr::read_csv('./input/player_play.csv')
```

```{r}
# tracking data
tracking_union_mod <- readRDS("./input/tracking_union_mod.rds")
```

```{r}
# nflverse data
nflverse_joined <- readr::read_tsv("./input/nflverse_joined.tsv")
```

## Helper Functions

```{r}
calculate_distance <- function(x1, x2, y1, y2) {
   
   dx = x1 - x2
   
   dy = y1 - y2
   
   sqrt(dx^2 + dy^2)
   
}
```

# EDA

## Isolating Plays

Exclude plays where there is no ambiguity of a team's intentions; a.k.a.
with an `xpass` value of 1 (offensive is lined up in empty formation with no
running backs).

## Isolating OL

Create copies of tracking data that only include pre-snap frames of
offensive linemen (T, G, and C) and the football itself

```{r}
tracking_football <- 
   tracking_union_mod |> 
   filter(nflId == 0, frameIdSlid <= 0) |> 
   select(gameId, playId, frameIdSlid, x_fb = x, y_fb = y)
```

```{r}
tracking_OL <- 
   tracking_union_mod |> 
   inner_join(players |> select(nflId, position), 
              by = join_by(nflId)) |> 
   inner_join(tracking_football, 
              by = join_by(gameId, playId, frameIdSlid)) |> 
   inner_join(plays |> select(gameId, playId, possessionTeam, defensiveTeam),
              by = join_by(gameId, playId)) |> 
   mutate(isOffense = as.integer(club == possessionTeam)) |> 
   mutate(isPositionOL = as.integer(position %in% c("C","G","T"))) |> 
   mutate(distanceToBall = calculate_distance(x, x_fb, y, y_fb)) |> 
   filter(isPositionOL == 1) |> 
   select(-possessionTeam, -defensiveTeam)
```

Sometimes players will play in other positions beside their "official"
position listed in the `players` dataset. We'll create a new feature that
identifies each player's position base on how they are aligned in the actual
play.

```{r}
tracking_OL_alignments <- 
   tracking_OL |> 
   filter(frameIdSlid == -1) |> 
   mutate(distanceToBall = round(distanceToBall, digits = 1)) |> 
   mutate(dy = round(y - y_fb, digits = 1)) |> 
   mutate(dyAbs = abs(dy)) |> 
   group_by(gameId, playId) |> 
   mutate(distRank = rank(dyAbs, ties.method = "min")) |> 
   ungroup() |> 
   mutate(distRankGroup = case_when(distRank == 1 ~ 1,
                                    distRank %in% c(2,3) ~ 2,
                                    distRank %in% c(4,5) ~ 3,
                                    distRank %in% c(5,6) ~ 4,
                                    TRUE ~ NA_integer_)) |> 
   mutate(sideOfBall = case_when(dyAbs <= 0.2 & distRankGroup == 1 ~ "C",
                                 dy > 0 ~ "L",
                                 dy < 0 ~ "R",
                                 TRUE ~ "ERR")) |> 
   mutate(positionOL = 
             case_when(
                sideOfBall == "C" ~ "C",
                sideOfBall %in% c("L","R") & distRankGroup == 2 ~ paste0(sideOfBall,"G"),
                sideOfBall %in% c("L","R") & distRankGroup == 3 ~ paste0(sideOfBall,"T"),
                TRUE ~ "ERR_OTHER"
                ))
```

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you
execute code within the notebook, the results appear beneath the code.

Try executing this chunk by clicking the *Run* button within the chunk or by
placing your cursor inside it and pressing *Ctrl+Shift+Enter*.

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by
pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will
be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to
preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor.
Consequently, unlike *Knit*, *Preview* does not run any R code chunks.
Instead, the output of the chunk when it was last run in the editor is
displayed.
